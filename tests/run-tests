#!/bin/bash
#
# Installs Chrome or Firefox if missing
#
BINDIR=./browsers/bin

if [ -z $TRAVIS ]; then
	echo "No TRAVIS env variable, we must be running locally. Assuming OSX."
  if [ -z $BROWSER ]; then
	   # Default to Chrome
     BROWSER="chrome"
  fi
  if [ -z $BVER ]; then
    # Default to Stable
    BVER="stable"
  fi
  case ${BROWSER}-${BVER} in
    chrome-stable) BROWSERBIN="/Applications/Google Chrome.app/Contents/MacOS/Google Chrome";;
    chrome-beta) BROWSERBIN="/Applications/Google Chrome Beta.app/Contents/MacOS/Google Chrome";;
    chrome-unstable) BROWSERBIN="/Applications/Google Chrome Canary.app/Contents/MacOS/Google Chrome Canary";;
    firefox-stable) BROWSERBIN="/Applications/Firefox.app/Contents/MacOS/firefox";;
    firefox-beta) BROWSERBIN="/Applications/Firefox Beta.app/Contents/MacOS/firefox";;
    firefox-unstable) BROWSERBIN="/Applications/FirefoxDeveloperEdition.app/Contents/MacOS/firefox";;
  esac
else
	BROWSERBIN=$BINDIR/$BROWSER-$BVER
fi

if [ $BROWSER == 'ie' ]; then
  protractor tests/protractor-saucelabs-ie.conf.js
else
  if [ ! -x $BROWSERBIN ]; then
    echo "Installing browser."
    ./node_modules/travis-multirunner/setup.sh
  fi
  PATH=$PATH:./node_modules/.bin
  # Karma uses ${BROWSER}_BIN, eg. CHROME_BIN, to override the path to the browser
  BROWSER_UPPER=$(echo "$BROWSER" | tr '[:lower:]' '[:upper:]')
  BROWSER_CAMEL=${BROWSER_UPPER:0:1}${BROWSER:1}
  export ${BROWSER_UPPER}_BIN="$BROWSERBIN"
  echo "Starting Karma for browser $BROWSER_CAMEL using $BROWSERBIN"
  karma start tests/karma.conf.js --single-run --browsers $BROWSER_CAMEL

  echo "Running Protractor tests"
  webdriver-manager update
  protractor tests/protractor-$BROWSER.conf.js
fi
